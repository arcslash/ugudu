name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

env:
  GO_VERSION: '1.22'
  NODE_VERSION: '20'

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get version
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: web/package-lock.json

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Build web UI
        run: |
          cd web
          npm ci
          npm run build
          cd ..
          rm -rf internal/api/ui
          mkdir -p internal/api/ui
          cp -r web/dist/* internal/api/ui/

      - name: Build binaries
        run: |
          VERSION=${{ steps.version.outputs.VERSION }}

          for PLATFORM in darwin/amd64 darwin/arm64 linux/amd64 linux/arm64 windows/amd64; do
            GOOS="${PLATFORM%/*}"
            GOARCH="${PLATFORM#*/}"
            OUTPUT="ugudu"
            [ "$GOOS" = "windows" ] && OUTPUT="ugudu.exe"

            mkdir -p "dist/ugudu_${VERSION}_${GOOS}_${GOARCH}"

            echo "Building for ${GOOS}/${GOARCH}..."
            GOOS="$GOOS" GOARCH="$GOARCH" go build \
              -ldflags "-s -w -X main.Version=${VERSION}" \
              -o "dist/ugudu_${VERSION}_${GOOS}_${GOARCH}/${OUTPUT}" \
              ./cmd/ugudu

            cp README.md "dist/ugudu_${VERSION}_${GOOS}_${GOARCH}/"
            [ -f LICENSE ] && cp LICENSE "dist/ugudu_${VERSION}_${GOOS}_${GOARCH}/"
          done

      - name: Create archives
        run: |
          VERSION=${{ steps.version.outputs.VERSION }}
          cd dist

          for dir in ugudu_${VERSION}_darwin_* ugudu_${VERSION}_linux_*; do
            tar -czvf "${dir}.tar.gz" "$dir"
            rm -rf "$dir"
          done

          for dir in ugudu_${VERSION}_windows_*; do
            zip -r "${dir}.zip" "$dir"
            rm -rf "$dir"
          done

          shasum -a 256 *.tar.gz *.zip > checksums.txt
          cat checksums.txt

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: dist/*
          generate_release_notes: true
          body: |
            ## Ugudu v${{ steps.version.outputs.VERSION }}

            ### Install

            **macOS/Linux:**
            ```bash
            curl -fsSL https://raw.githubusercontent.com/arcslash/ugudu/main/install.sh | bash
            ```

            **Windows (PowerShell):**
            ```powershell
            irm https://raw.githubusercontent.com/arcslash/ugudu/main/install.ps1 | iex
            ```

            ### Quick Start

            ```bash
            ugudu setup          # Configure API keys
            ugudu daemon         # Start with web UI
            open http://localhost:9741
            ```
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
